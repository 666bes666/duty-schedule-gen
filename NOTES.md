# Notes — архив комментариев из Python-файлов

Собрано из репозитория `duty-schedule-gen`.

## `app.py`

```
Line   29: # ── Константы ────────────────────────────────────────────────────────────────
Line   42: # Дни недели
Line   49: # «Отпуск» и «Недоступен» вынесены в отдельный дейт-пикер (не текстовые поля)
Line   89: # Тип конфига дат сотрудника:
Line   90: # {"vacations": [(start, end), ...], "unavailable": [date, ...]}
Line   91: # typing alias
Line   94: # ── Session state ─────────────────────────────────────────────────────────────
Line  113: # {name: {"vacations": [(date, date), ...], "unavailable": [date, ...]}}
Line  115: # Кешированные копии для sidebar (избегаем dict-from-data_editor)
Line  128: # ── Вспомогательные функции для дат ──────────────────────────────────────────
Line  173: # ── Сериализация / десериализация ─────────────────────────────────────────────
Line  215: # type: ignore[arg-type]
Line  337: # Даты — в отдельный словарь
Line  340: # Предпочтительная смена
Line  387: # Даты из date-picker session state
Line  411: # type: ignore[arg-type]
Line  445: # ── Конвертация расписания ↔ DataFrame ────────────────────────────────────────
Line  450: # type: ignore[attr-defined]
Line  466: # type: ignore[attr-defined]
Line  467: # type: ignore[attr-defined]
Line  472: # type: ignore[union-attr]
Line  502: # type: ignore[attr-defined]
Line  506: # type: ignore[attr-defined]
Line  509: # ── Валидация конфигурации ─────────────────────────────────────────────────────
Line  556: # ── Календарный вид расписания ─────────────────────────────────────────────────
Line  559: # утро — янтарный
Line  560: # вечер — голубой
Line  561: # ночь — сиреневый
Line  562: # рабочий день — зелёный
Line  563: # выходной — серый
Line  564: # отпуск — розовый
Line  573: # type: ignore[attr-defined]
Line  615: # ── Дашборд нагрузки ──────────────────────────────────────────────────────────
Line  626: # type: ignore[attr-defined]
Line  661: # type: ignore[attr-defined]
Line  676: # type: ignore[arg-type]
Line  696: # ── Страница ──────────────────────────────────────────────────────────────────
Line  703: # ── Панель: загрузка конфига (sidebar) ───────────────────────────────────────
Line  727: # Обновляем кеши для download-кнопки
Line  740: # Используем _df_for_download — DataFrame, сохранённый после последнего
Line  741: # рендера data_editor. Это избегает AttributeError: session_state[key]
Line  742: # у data_editor хранит dict изменений, а не сам DataFrame.
Line  762: # ── Выбор периода ─────────────────────────────────────────────────────────────
Line  781: # ── Wizard: разделы настройки ─────────────────────────────────────────────────
Line  793: # Опции для «Группа» — кешируются на table_version, чтобы не сбрасывать delta
Line  876: # ── Пресеты (Feature 4) ───────────────────────────────────────────────────
Line  902: # ── 👤 Карточка сотрудника ────────────────────────────────────────────────
Line  915: # Сводка параметров
Line  940: # ── Периоды отпуска ───────────────────────────────────────────────
Line  973: # ── Недоступные дни ──────────────────────────────────────────────
Line  998: # ── Постоянные выходные дни недели ────────────────────────────────
Line 1065: # ── Предварительная валидация ─────────────────────────────────────────────────
Line 1072: # ── Кнопка генерации ──────────────────────────────────────────────────────────
Line 1132: # Единая бизнес-валидация конфигурации (та же, что и в CLI)
Line 1168: # ── Сохранить результат (Feature 5: не пропадает при изменениях) ──────────
Line 1183: # ── Результаты: остаются при любых изменениях конфига (Feature 5) ─────────────
Line 1211: # edited_schedule_df инициализируем базовым значением — переопределится editor'ом
Line 1236: # Кешируем XLS — перегенерируем только при изменении таблицы редактора
```

## `src/duty_schedule/calendar.py`

```
Line   17: # Коды: 0=рабочий, 1=выходной/праздник, 2=сокращённый (6-часовой), 4=предпраздничный
```

## `src/duty_schedule/cli.py`

```
Line   62: # Загрузка конфигурации
Line   71: # Дополнительная бизнес-валидация (единая с веб-интерфейсом)
Line   87: # Загрузка производственного календаря
Line   93: # Генерация расписания
Line  103: # Экспорт
Line  126: # Итоговая статистика
Line  191: # Добавляем выходные по умолчанию (суббота/воскресенье)
Line  207: # noqa: ANN001
```

## `src/duty_schedule/export/ics.py`

```
Line   21: # Смены для экспорта в ICS (не включаем DAY_OFF / VACATION)
Line   24: # Часовые пояса по городу
Line   27: # Хабаровск UTC+10
Line   30: # Рабочий день Хабаровска по местному времени
Line   45: # Вечер заканчивается в 00:00 следующего дня
Line   88: # Индекс: имя → город
Line  100: # Хабаровские сотрудники в workday — местное время
```

## `src/duty_schedule/export/xls.py`

```
Line   15: # Цветовая схема
Line   17: # зелёный
Line   18: # тёмно-синий
Line   19: # бирюзовый
Line   20: # ярко-синий
Line   21: # оранжевый
Line   22: # сиреневый
Line   23: # тёмно-серый
Line   24: # светло-серый
Line   25: # выходная дата
Line   26: # светло-зелёный (норма выполнена)
Line   27: # жёлтый (немного недобирает)
Line   28: # красный (значительно недобирает)
Line   29: # голубой (перевыполнение)
Line   30: # тёмно-синий заголовок статистики
Line   31: # раздел статистики
Line   32: # строка итогов
Line   79: # ── Утилиты стиля ────────────────────────────────────────────────────────────
Line   95: # ── Построение индекса назначений ────────────────────────────────────────────
Line  116: # ── Структура статистики ─────────────────────────────────────────────────────
Line  123: # всего рабочих дней
Line  124: # норма
Line  125: # утренних смен
Line  126: # вечерних смен
Line  127: # ночных смен
Line  128: # рабочих дней (не дежурство)
Line  129: # выходных
Line  130: # отпуск
Line  131: # работал в субботу/воскресенье
Line  132: # работал в официальные праздники (Пн–Пт)
Line  133: # макс. серия рабочих дней подряд
Line  134: # макс. серия выходных подряд
Line  135: # изолированные выходные (окружённые рабочими днями)
Line  136: # сдвоенные выходные (блоки из 2+ последовательных выходных/отпускных)
Line  161: # Работал в субботу/воскресенье
Line  164: # Работал в официальные праздники (Пн–Пт, не выходные)
Line  171: # Макс. серии
Line  215: # ── Главный экспорт ──────────────────────────────────────────────────────────
Line  241: # ── Лист 1: График ──────────────────────────────────────────────────────
Line  244: # ── Лист 2: Статистика ──────────────────────────────────────────────────
Line  248: # ── Лист 3: Легенда ─────────────────────────────────────────────────────
Line  255: # noqa: ANN001
Line  259: # ── Строка 1: заголовок месяца ───────────────────────────────────────────
Line  269: # ── Строка 2: заголовки дат ──────────────────────────────────────────────
Line  290: # ── Строки сотрудников (с 3-й) ───────────────────────────────────────────
Line  324: # noqa: ANN001
Line  340: # ── Заголовок листа ──────────────────────────────────────────────────────
Line  348: # ── Группы заголовков (строка 2) ─────────────────────────────────────────
Line  366: # ── Заголовки столбцов (строка 3) ────────────────────────────────────────
Line  368: # A  col 1
Line  369: # B  col 2
Line  370: # C  col 3
Line  371: # D  col 4
Line  372: # E  col 5
Line  373: # F  col 6
Line  374: # G  col 7
Line  375: # H  col 8
Line  376: # I  col 9
Line  377: # J  col 10
Line  378: # K  col 11  ← Сб/Вс
Line  379: # L  col 12  ← официальные, Пн–Пт
Line  380: # M  col 13
Line  381: # N  col 14
Line  382: # O  col 15
Line  383: # P  col 16  ← Изол. выходных
Line  384: # Q  col 17  ← Сдвоен. выходных
Line  390: # ── Строки сотрудников (с 4-й) ───────────────────────────────────────────
Line  406: # Имя
Line  412: # Город
Line  419: # Норма
Line  423: # Смены
Line  429: # Отдых
Line  439: # Нагрузка
Line  445: # Накапливаем итоги
Line  456: # ── Строка итогов по команде ──────────────────────────────────────────────
Line  474: # ── Ширина столбцов ───────────────────────────────────────────────────────
Line  483: # noqa: ANN001
```

## `src/duty_schedule/models.py`

```
Line   31: # Shift time bounds (MSK)
Line   40: # next day
Line   75: # Фича 1: лимиты типов смен в месяц (None = без ограничений)
Line   79: # Фича 2: предпочтительная смена (мягкий приоритет при выборе)
Line   81: # Фича 3: норма нагрузки в % (100 = полная ставка, 50 = 0.5 ставки)
Line   83: # Фича 4: постоянные выходные дни недели (0=Пн … 6=Вс)
Line   85: # Фича 5: индивидуальный лимит рабочих дней подряд (None = глобальный дефолт 5)
Line   87: # Фича 6: группа — не ставить двух из одной группы на одну смену в один день
Line  223: # Базовые проверки поверх pydantic-валидации
Line  227: # Уникальность имён сотрудников
Line  240: # Валидация пинов (фиксированных назначений)
Line  259: # Городские ограничения для типов смен
Line  274: # Информационные предупреждения о нетипичных комбинациях
Line  285: # Переносимые состояния для отсутствующих сотрудников
```

## `src/duty_schedule/scheduler.py`

```
Line   24: # глобальный дефолт; перекрывается Employee.max_consecutive_working
Line   62: # Норма рабочих дней и вакационные дни
Line  152: # предпочтение разбивает тайбрейк
Line  199: # норма выполнена — низкий приоритет
Line  200: # urgency = дефицит / оставшиеся дни: чем выше, тем срочнее
Line  251: # Пре-заполняем назначения пинами (фиксированные назначения имеют приоритет)
Line  254: # ── Фаза 1: Ночная смена (Хабаровск, обязательно каждый день) ──────────
Line  255: # Ночная смена 00-08 МСК = 07-15 по местному времени Хабаровска.
Line  256: # После неё 16 часов отдыха до следующей ночи и >18 часов до рабочего дня 09-18.
Line  257: # Поэтому принудительный отдых на следующий день НЕ применяется.
Line  282: # ── Фаза 2: Утренняя и вечерняя смены (Москва, обязательно) ───────────
Line  297: # Группы, уже занявшие утреннюю смену (пины)
Line  334: # Группы, уже занявшие вечернюю смену (пины)
Line  374: # ── Фаза 2b: Не-дежурный рабочий день (Москва) ──────────────────────────
Line  375: # Всем московским дежурным с дефицитом нормы назначаем рабочий день 09-18.
Line  376: # Нет жёсткого «один всегда отдыхает» — это приводило к систематической
Line  377: # недовыработке. Единственное ограничение: если ЗАВТРА выходной/праздник,
Line  378: # обеспечиваем ≥ 2 дежурных с consecutive_working < MAX для обязательных
Line  379: # утренней/вечерней смен (иначе никого не останется на субботу/воскресенье).
Line  400: # Проверка «кануна выходного»: после этого назначения должны
Line  401: # остаться ≥ 2 дежурных с cw < MAX для завтрашних обязательных смен.
Line  412: # day_off/vacation → cw=0
Line  419: # Неназначенные московские дежурные → выходной или отпуск
Line  426: # ── Фаза 2c: Хабаровские дежурные — рабочий день по местному времени ───
Line  427: # Хабаровские сотрудники работают ТОЛЬКО ночные смены (MSK) или свой
Line  428: # местный рабочий день (09-18 Хабаровск = ShiftType.WORKDAY).
Line  429: # Они НЕ работают в московское утро или вечер.
Line  430: # Рабочий день (09-18) возможен только в будни — в выходные и праздники
Line  431: # допустимы только дежурные смены (ночь и т.п.).
Line  434: # уже на ночной смене
Line  441: # Принудительный отдых после ночи НЕ применяется: ночь 00-08 МСК =
Line  442: # 07-15 КХСТ, после неё достаточно времени до следующего дня 09-18 КХСТ.
Line  444: # В выходные и праздники рабочего дня (9-18) нет — только дежурства
Line  450: # Назначаем рабочий день по местному времени (для выработки нормы),
Line  451: # но сначала проверяем: не исчерпаем ли мы всех хабаровчан одновременно.
Line  452: # Если после WORKDAY у этого сотрудника cw достигнет MAX — нужно убедиться,
Line  453: # что хотя бы один другой хабаровчанин будет доступен завтра для ночи.
Line  467: # сегодня отдыхает → cw=0 завтра
Line  472: # не назначен или иной
Line  481: # ── Фаза 3: Рабочий день (не-дежурные) ─────────────────────────────────
Line  482: # Не-дежурные сотрудники не нужны в выходные/праздники вне зависимости
Line  483: # от типа расписания (flexible или 5/2).
Line  486: # пин переопределяет назначение
Line  494: # ── Фаза 4: Ограничение максимум 3 выходных подряд ─────────────────────
Line  495: # Если дежурный отдыхает 3+ дня подряд и ещё не выработал норму,
Line  496: # назначаем рабочий день (только в будни). Дежурные смены уже заняты
Line  497: # выбранными сотрудниками — добавлять вторых нельзя.
Line  498: # _can_work уже учитывает is_day_off_weekly и _max_cw.
Line  507: # WORKDAY только в будни
Line  511: # ── Собираем DaySchedule ────────────────────────────────────────────────
Line  515: # ── Обновляем состояния ─────────────────────────────────────────────────
Line  613: # Нельзя ставить рабочий день после вечерней смены
Line  616: # Не превышаем per-employee MAX рабочих дней подряд
Line  662: # safety limit
Line  681: # max_name несёт дежурство в этот выходной
Line  689: # min_name отдыхает в этот выходной
Line  693: # Проверяем ограничения для min_name
Line  700: # Проверяем, что min_name не превысит лимит смен данного типа
Line  714: # После вечерней смены нельзя ставить утро (min_name)
Line  719: # Выполняем замену
Line  754: # Индекс дат для быстрого поиска предыдущего дня
Line  757: # safety limit
Line  774: # max_name должен нести дежурство в этот день
Line  782: # min_name должен быть на рабочем дне (WORKDAY) в этот день
Line  786: # Проверяем, что min_name может работать этот тип смены
Line  793: # Проверяем, что min_name не превысит лимит смен данного типа
Line  808: # max_name получит WORKDAY — недопустимо, если вчера у него был вечер
Line  811: # min_name получит дежурство — для утра нельзя, если вчера у него был вечер
Line  815: # Выполняем замену
Line  855: # Индекс пинов по дате
Line  861: # Норма рабочих дней по производственному календарю
Line  865: # Инициализация состояний с нормами
Line  869: # Фича 3: норма нагрузки пропорционально workload_pct
Line  876: # Перенос состояния с предыдущего месяца
Line  890: # суммарный счётчик откатов (не сбрасывается)
Line  931: # Пересчитываем рабочие дни: _balance_weekend_work меняет duty ↔ day_off,
Line  932: # что сдвигает total_working — синхронизируем состояния перед norm-коррекцией.
Line  939: # Баланс вечерних смен (информационное логирование)
Line  946: # Метаданные
Line  955: # Отчёт по выработке
Line  969: # Финальные состояния для переноса на следующий месяц
```

## `tests/conftest.py`

```
Line   67: # Москва — дежурные
Line   73: # Москва — не дежурный (5/2)
Line   75: # Москва — 5/2 (не дежурный)
Line   77: # Хабаровск — дежурные
Line  107: # 8 Марта
Line  108: # выходной
```

## `tests/integration/test_edge_cases.py`

```
Line   38: # Ночные смены должны быть у обоих хабаровчан
Line  238: # Блокируем первого московского дежурного на 5-е число
Line  299: # Симулируем: «Москва 1» закончил предыдущий месяц вечерней сменой
Line  304: # Москва 1 не должен стоять на утренней смене 1-го числа (resting after evening)
```

## `tests/integration/test_full_schedule.py`

```
Line  105: # Новый формат: строки = сотрудники, столбцы = даты
Line  106: # заголовок + 31 день
Line  107: # заголовок + минимум 6 сотрудников
Line  131: # Должен содержать хотя бы один компонент
```

## `tests/integration/test_new_features.py`

```
Line   27: # ── Фича 1: Лимиты смен ───────────────────────────────────────────────────────
Line  106: # ── Фича 2: Предпочтительная смена ───────────────────────────────────────────
Line  124: # Просто проверяем, что расписание строится и preferred_shift принимается
Line  143: # ── Фича 3: Норма нагрузки ────────────────────────────────────────────────────
Line  164: # 50% загрузка → значительно меньше рабочих дней
Line  195: # ── Фича 4: Постоянные выходные дни недели ────────────────────────────────────
Line  214: # Понедельник
Line  221: # нет в выходные
Line  239: # ── Фича 5: Индивидуальный лимит серии ───────────────────────────────────────
Line  294: # ── Фича 6: Группы ────────────────────────────────────────────────────────────
```

## `tests/integration/test_randomized_schedules.py`

```
Line   13: # Москва: 4–7 дежурных
Line   15: # Хабаровск: 2–4 дежурных
Line   65: # Полное покрытие смен
Line   70: # Ночная смена — только хабаровск
Line   74: # Утро/вечер — только москва
Line   78: # Не более одной смены (утро/вечер/ночь/рабочий день) на человека в день
```

## `tests/unit/test_calendar.py`

```
Line   58: # Март 2025: 31 день, ответ API — строка из 31 символа
Line   59: # Помечаем 8-е (0-based индекс 7) как праздник (код "1")
Line   60: # 8 марта = праздник
Line   82: # неверная длина
```

## `tests/unit/test_constraints.py`

```
Line   27: # суббота
Line   30: # воскресенье
Line   33: # понедельник
Line   81: # суббота
Line  141: # понедельник
Line  194: # Один на ночи, второй — либо workday либо day_off
```

## `tests/unit/test_models.py`

```
Line  108: # не отпуск — только блокировка
Line  118: # отпуск
Line  119: # разовая блокировка
Line  165: # Не-дежурный не влияет на минимальный состав дежурных
```

## `tests/unit/test_scheduler.py`

```
Line   55: # Хотя бы один день должен отличаться
Line   74: # Даём Москва 1 отпуск на первую неделю
Line  125: # Считаем, сколько раз хабаровский работал на следующий день после ночи
Line  138: # Ограничение снято — хабаровчане должны работать после ночей
Line  191: # Проверяем что хабаровские не в московских сменах
```

